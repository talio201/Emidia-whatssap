// Content Script - Injeta c√≥digo no WhatsApp Web
console.log("‚úì Content Script carregado no WhatsApp Web");

// Vari√°vel para rastrear modo de sele√ß√£o
let modoSelecaoAtivo = false;
const contatosClicados = new Set();

// Fun√ß√£o auxiliar para debugar estrutura do bot√£o de envio
function debugBotaoEnvio() {
  console.log("üîç === DEBUG: Estrutura do DOM para envio ===");
  
  // Procura por todos os buttons
  const allButtons = document.querySelectorAll('button');
  console.log(`Total de buttons: ${allButtons.length}`);
  
  allButtons.forEach((btn, idx) => {
    const aria = btn.getAttribute('aria-label') || 'sem aria-label';
    const testid = btn.getAttribute('data-testid') || 'sem data-testid';
    const title = btn.getAttribute('title') || 'sem title';
    const classes = btn.className || 'sem classes';
    
    // Log apenas bot√µes relevantes (com atributos de envio)
    if (aria.toLowerCase().includes('enviar') || 
        aria.toLowerCase().includes('send') ||
        testid.includes('send') ||
        title.toLowerCase().includes('enviar') ||
        title.toLowerCase().includes('send')) {
      console.log(`[${idx}] aria-label="${aria}", data-testid="${testid}", title="${title}", classes="${classes}"`);
    }
  });
  
  // Procura por divs com role="button"
  const divButtons = document.querySelectorAll('div[role="button"]');
  console.log(`\nTotal de div[role="button"]: ${divButtons.length}`);
  
  divButtons.forEach((div, idx) => {
    const aria = div.getAttribute('aria-label') || 'sem aria-label';
    if (aria.toLowerCase().includes('enviar') || aria.toLowerCase().includes('send')) {
      console.log(`[${idx}] div aria-label="${aria}"`);
    }
  });
  
  console.log("=== FIM DEBUG ===\n");
}


  console.log("\n=== EXTRAINDO CONTATOS ===");
  const contatos = [];
  
  try {
    console.log("Testando diferentes seletores...");
    
    // Testa v√°rios seletores poss√≠veis
    const seletores = [
      '[role="navigation"]',
      '[role="list"]',
      '[role="main"]',
      'main',
      '.x1n2onr6',  // Classes do WhatsApp
      '[aria-label*="chat"]',
      '[data-testid="chat-list"]'
    ];
    
    let elementoPai = null;
    
    for (let seletor of seletores) {
      const elemento = document.querySelector(seletor);
      if (elemento) {
        console.log("‚úì Encontrado:", seletor);
        elementoPai = elemento;
        break;
      }
    }
    
    if (!elementoPai) {
      console.log("Procurando pela estrutura geral...");
      // Debug: mostra a estrutura do body
      console.log("Body HTML (primeiras 2000 chars):", document.body.innerHTML.substring(0, 2000));
      
      // Procura por qualquer elemento que contenha v√°rios span[dir="auto"]
      const todasDivs = document.querySelectorAll('div');
      console.log("Total de divs:", todasDivs.length);
      
      // Encontra a div que tem mais spans[dir="auto"]
      let melhorDiv = null;
      let maxSpans = 0;
      
      todasDivs.forEach(div => {
        const spansNaDiv = div.querySelectorAll('span[dir="auto"]');
        if (spansNaDiv.length > maxSpans && spansNaDiv.length < 100) {
          maxSpans = spansNaDiv.length;
          melhorDiv = div;
        }
      });
      
      if (melhorDiv) {
        console.log("‚úì Melhor div encontrada com", maxSpans, "spans");
        elementoPai = melhorDiv;
      }
    }
    
    if (elementoPai) {
      console.log("Extraindo spans do elemento pai...");
      const spans = elementoPai.querySelectorAll('span[dir="auto"]');
      console.log("Total de spans:", spans.length);
      
      const contatosEncontrados = new Set();
      
      spans.forEach((span, index) => {
        const texto = span.textContent.trim();
        
        if (texto && 
            texto.length >= 2 && 
            texto.length <= 100 &&
            !texto.match(/^[\d:]+$/) &&        // Rejeita apenas hor√°rios
            !texto.endsWith('"') &&
            texto.split(' ').length <= 6) {   // M√°ximo 6 palavras
          
          contatosEncontrados.add(texto);
          console.log(`[${index}] ‚úì ${texto}`);
        }
      });
      
      console.log("Contatos filtrados:", contatosEncontrados.size);
      
      contatosEncontrados.forEach(nome => {
        contatos.push({
          id: nome,
          nome: nome
        });
      });
    } else {
      console.log("‚ùå N√£o foi poss√≠vel encontrar a lista de chats");
    }
    
  } catch (erro) {
    console.error("‚ùå Erro ao extrair contatos:", erro);
  }
  
  console.log("=== RESULTADO: " + contatos.length + " contatos ===\n");
  return contatos;
}

// Fun√ß√£o para enviar mensagem
function enviarMensagem(numeroOuNome, mensagem) {
  return new Promise((resolve) => {
    try {
      console.log(`üì§ Iniciando envio para: ${numeroOuNome}`);
      
      // Estrat√©gia: usar a mesma que funciona em extrairContatos
      // Encontra o container principal
      const containerPrincipal = document.querySelector('.x1n2onr6');
      if (!containerPrincipal) {
        console.log("‚ùå Container principal n√£o encontrado");
        resolve({ sucesso: false, mensagem: "Container n√£o encontrado" });
        return;
      }
      
      // Procura por todos os span[dir="auto"] dentro do container
      const spans = containerPrincipal.querySelectorAll('span[dir="auto"]');
      console.log(`üîç Procurando "${numeroOuNome}" entre ${spans.length} spans`);
      
      let elementoClicavel = null;
      
      // Procura o span que tem o nome exato
      for (let span of spans) {
        const texto = span.textContent.trim();
        if (texto === numeroOuNome) {
          console.log(`‚úì Encontrado span com nome: "${texto}"`);
          
          // Encontra o elemento "clic√°vel" mais pr√≥ximo (pai com role="button" ou similar)
          let elemento = span;
          for (let i = 0; i < 10; i++) {
            elemento = elemento.parentElement;
            if (!elemento) break;
            
            // Verifica se √© clic√°vel
            if (elemento.onclick || 
                elemento.getAttribute('role') === 'button' ||
                elemento.getAttribute('role') === 'link' ||
                elemento.className.includes('clickable') ||
                elemento.style.cursor === 'pointer') {
              elementoClicavel = elemento;
              console.log(`‚úì Elemento clic√°vel encontrado no n√≠vel ${i}`);
              break;
            }
          }
          
          // Se n√£o encontrou com role/onclick, tenta um ancestral gen√©rico
          if (!elementoClicavel) {
            elemento = span;
            for (let i = 0; i < 5; i++) {
              elemento = elemento.parentElement;
              if (!elemento) break;
              // Pega o div mais pr√≥ximo que parece um "item"
              if (elemento.tagName === 'DIV' && !elemento.className.includes('hidden')) {
                elementoClicavel = elemento;
                console.log(`‚úì Elemento DIV encontrado no n√≠vel ${i}`);
                break;
              }
            }
          }
          
          break;
        }
      }
      
      if (!elementoClicavel) {
        console.log(`‚ùå Contato n√£o encontrado: ${numeroOuNome}`);
        const spanDisponiveis = Array.from(spans).map(s => s.textContent.trim()).slice(0, 20);
        console.log("Contatos dispon√≠veis:", spanDisponiveis);
        resolve({ sucesso: false, mensagem: "Contato n√£o encontrado" });
        return;
      }
      
      // Clica no elemento
      console.log("üñ±Ô∏è Clicando no elemento...");
      elementoClicavel.click();
      
      // Aguarda a conversa abrir (at√© 2 segundos)
      let tentativas = 0;
      const aguardarConversa = setInterval(() => {
        tentativas++;
        
        // Procura pelo input de mensagem
        const inputMensagem = document.querySelector('[contenteditable="true"][role="textbox"]') ||
                             document.querySelector('[contenteditable="true"]');
        
        if (inputMensagem && tentativas <= 4) {
          clearInterval(aguardarConversa);
          console.log("‚úì Chat aberto, enviando mensagem...");
          
          // Limpa input anterior
          inputMensagem.textContent = "";
          inputMensagem.innerHTML = "";
          
          // Insere a mensagem como texto
          inputMensagem.textContent = mensagem;
          inputMensagem.dispatchEvent(new Event('input', { bubbles: true }));
          inputMensagem.dispatchEvent(new Event('change', { bubbles: true }));
          inputMensagem.focus();
          
          // Debug: mostra estrutura do bot√£o de envio
          setTimeout(() => {
            debugBotaoEnvio();
          }, 200);
          
          // Aguarda um pouco e depois envia
          setTimeout(() => {
            console.log("üîé Procurando bot√£o de envio...");
            
            // Lista de seletores para encontrar o bot√£o
            const seletoresBotao = [
              'button[aria-label*="Enviar"]',
              'button[aria-label*="Send"]',
              'button[aria-label="Enviar"]',
              'button[aria-label="Send"]',
              'button[data-testid="composer_send_button"]',
              'button[aria-label*="enviar"]',
              'button[aria-label="enviar"]',
              'button svg[viewBox="0 0 24 24"]', // Bot√£o com √≠cone
              'div[role="button"][aria-label*="Enviar"]',
              'div[role="button"][aria-label*="Send"]',
              'button[type="button"][class*="send"]',
              'button[class*="send"]'
            ];
            
            let botaoEnvio = null;
            for (let seletor of seletoresBotao) {
              botaoEnvio = document.querySelector(seletor);
              if (botaoEnvio) {
                console.log(`‚úì Bot√£o encontrado com seletor: ${seletor}`);
                break;
              }
            }
            
            if (botaoEnvio) {
              console.log("üñ±Ô∏è Clicando no bot√£o de envio...");
              botaoEnvio.click();
              
              // Aguarda um pouco e verifica se foi enviado
              setTimeout(() => {
                const inputAposEnvio = document.querySelector('[contenteditable="true"][role="textbox"]') ||
                                      document.querySelector('[contenteditable="true"]');
                
                if (inputAposEnvio && (inputAposEnvio.textContent === "" || inputAposEnvio.innerHTML === "")) {
                  console.log("‚úÖ Mensagem enviada com sucesso!");
                  resolve({ sucesso: true, mensagem: "Mensagem enviada!" });
                } else {
                  console.log("‚ö†Ô∏è Campo ainda tem texto, tentando novamente...");
                  // Tenta novamente se ainda houver texto
                  botaoEnvio.click();
                  setTimeout(() => {
                    resolve({ sucesso: true, mensagem: "Mensagem enviada!" });
                  }, 500);
                }
              }, 500);
            } else {
              // M√©todo alternativo: tenta Ctrl+Enter
              console.log("‚ö†Ô∏è Bot√£o n√£o encontrado, tentando Ctrl+Enter...");
              
              const eventoCtrlEnter = new KeyboardEvent('keydown', {
                key: 'Enter',
                code: 'Enter',
                keyCode: 13,
                which: 13,
                ctrlKey: true,
                bubbles: true,
                cancelable: true
              });
              
              inputMensagem.dispatchEvent(eventoCtrlEnter);
              
              const eventoUp = new KeyboardEvent('keyup', {
                key: 'Enter',
                code: 'Enter',
                keyCode: 13,
                which: 13,
                ctrlKey: true,
                bubbles: true,
                cancelable: true
              });
              
              inputMensagem.dispatchEvent(eventoUp);
              
              // Tenta Enter normal tamb√©m
              setTimeout(() => {
                const eventoEnter = new KeyboardEvent('keydown', {
                  key: 'Enter',
                  code: 'Enter',
                  keyCode: 13,
                  which: 13,
                  bubbles: true,
                  cancelable: true
                });
                
                inputMensagem.dispatchEvent(eventoEnter);
                
                const eventoUpEnter = new KeyboardEvent('keyup', {
                  key: 'Enter',
                  code: 'Enter',
                  keyCode: 13,
                  which: 13,
                  bubbles: true,
                  cancelable: true
                });
                
                inputMensagem.dispatchEvent(eventoUpEnter);
                
                resolve({ sucesso: true, mensagem: "Mensagem enviada!" });
              }, 200);
            }
          }, 300);
          
        } else if (tentativas > 4) {
          clearInterval(aguardarConversa);
          console.log("‚ùå Timeout ao abrir chat");
          resolve({ sucesso: false, mensagem: "Timeout ao abrir chat" });
        }
      }, 500);
      
    } catch (e) {
      console.error("‚ùå Erro ao enviar mensagem:", e);
      resolve({ sucesso: false, mensagem: "Erro ao enviar: " + e.message });
    }
  });
}

// Fun√ß√£o para enviar arquivo
function enviarArquivo(numeroOuNome, arquivoData) {
  try {
    // Encontra e clica no contato
    const conversas = document.querySelectorAll('[data-testid="chat-list-item"]');
    
    conversas.forEach((conversa) => {
      const nomeElement = conversa.querySelector('[dir="auto"]');
      const nome = nomeElement ? nomeElement.textContent.trim() : "";
      
      if (nome === numeroOuNome) {
        conversa.click();
      }
    });
    
    setTimeout(() => {
      // Procura o bot√£o de anexar
      const botaoAnexar = document.querySelector('button[aria-label*="Anexar"]') ||
                         document.querySelector('button[aria-label*="attach"]');
      
      if (botaoAnexar) {
        botaoAnexar.click();
        return { sucesso: true, mensagem: "Clique no bot√£o de anexar para enviar o arquivo" };
      }
      return { sucesso: false, mensagem: "Bot√£o de anexar n√£o encontrado" };
    }, 500);
    
  } catch (e) {
    console.error("Erro ao enviar arquivo:", e);
    return { sucesso: false, mensagem: "Erro ao enviar arquivo" };
  }
}

// Listener para mensagens do popup
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
  console.log("Mensagem recebida:", request.action);
  
  if (request.action === "obterContatos") {
    const contatos = extrairContatos();
    console.log("Enviando contatos:", contatos);
    sendResponse({ sucesso: true, contatos });
    return true; // Importante: mant√©m o canal aberto
  } 
  else if (request.action === "enviarMensagem") {
    // Como enviarMensagem √© async (Promise), precisa de tratamento especial
    enviarMensagem(request.contato, request.mensagem).then((resultado) => {
      sendResponse(resultado);
    }).catch((erro) => {
      sendResponse({ sucesso: false, mensagem: "Erro: " + erro.message });
    });
    return true; // CR√çTICO: mant√©m canal aberto para resposta async
  }
  else if (request.action === "enviarArquivo") {
    const resultado = enviarArquivo(request.contato, request.arquivo);
    sendResponse(resultado);
    return true;
  }
  else if (request.action === "ativarModoSele√ß√£o") {
    modoSelecaoAtivo = request.ativo;
    if (modoSelecaoAtivo) {
      ativarModoSelecaoContatos();
    } else {
      desativarModoSelecaoContatos();
    }
    sendResponse({ sucesso: true });
    return true;
  }
  
  return false; // Se n√£o reconhecer a action, fecha o canal
});

// Fun√ß√£o para ativar modo de sele√ß√£o de contatos
let clickListenersAtivos = false;

function ativarModoSelecaoContatos() {
  console.log("üéØ Ativando modo de sele√ß√£o de contatos");
  
  if (clickListenersAtivos) {
    console.log("Listeners j√° est√£o ativos");
    return;
  }
  
  // Usa a mesma estrat√©gia de extrairContatos
  const containerPrincipal = document.querySelector('.x1n2onr6');
  if (!containerPrincipal) {
    console.log("‚ùå Container principal n√£o encontrado");
    return;
  }
  
  // Procura por todos os span[dir="auto"]
  const spans = containerPrincipal.querySelectorAll('span[dir="auto"]');
  console.log(`Encontrados ${spans.length} spans, procurando elementos clic√°veis...`);
  
  const elementosUnicos = new Set();
  
  // Para cada span, encontra seu elemento "clic√°vel" pai
  spans.forEach((span, idx) => {
    const texto = span.textContent.trim();
    
    // Filtra spans vazios ou muito curtos
    if (!texto || texto.length < 2 || texto.length > 100) return;
    
    // Encontra o elemento clic√°vel pai
    let elemento = span;
    for (let i = 0; i < 10; i++) {
      elemento = elemento.parentElement;
      if (!elemento) break;
      
      // Procura por um elemento que pare√ßa clic√°vel
      if (elemento.onclick || 
          elemento.getAttribute('role') === 'button' ||
          elemento.getAttribute('role') === 'link' ||
          elemento.className.includes('clickable') ||
          elemento.style.cursor === 'pointer' ||
          (elemento.tagName === 'DIV' && i >= 3)) { // DIV mais profundo
        
        // Verifica se j√° n√£o temos este elemento
        if (!elementosUnicos.has(elemento)) {
          elementosUnicos.add(elemento);
        }
        break;
      }
    }
  });
  
  console.log(`Preparando ${elementosUnicos.size} elementos para sele√ß√£o`);
  
  // Agora adiciona listeners a cada elemento √∫nico
  elementosUnicos.forEach((elemento, idx) => {
    // Remove listeners anteriores
    const novoElemento = elemento.cloneNode(true);
    elemento.parentNode.replaceChild(novoElemento, elemento);
    
    // Adiciona efeito visual
    novoElemento.style.cursor = "pointer";
    novoElemento.style.border = "2px solid transparent";
    novoElemento.style.borderRadius = "8px";
    novoElemento.style.transition = "border-color 0.2s, background-color 0.2s";
    
    // Hover para destacar
    novoElemento.addEventListener("mouseenter", function() {
      if (modoSelecaoAtivo) {
        this.style.borderColor = "#25D366";
        this.style.backgroundColor = "rgba(37, 211, 102, 0.1)";
      }
    });
    
    novoElemento.addEventListener("mouseleave", function() {
      this.style.borderColor = "transparent";
      this.style.backgroundColor = "";
    });
    
    // Click para selecionar
    novoElemento.addEventListener("click", function(e) {
      if (!modoSelecaoAtivo) return;
      
      e.preventDefault();
      e.stopPropagation();
      
      // Procura o nome dentro deste elemento
      const spanNoElemento = this.querySelector('span[dir="auto"]');
      let nome = "Desconhecido";
      
      if (spanNoElemento) {
        nome = spanNoElemento.textContent.trim();
      }
      
      console.log("‚úì Contato clicado:", nome);
      
      // Envia para popup
      chrome.runtime.sendMessage({
        action: "contatoSelecionado",
        contato: nome
      }, (response) => {
        if (chrome.runtime.lastError) {
          console.error("Erro ao enviar contato:", chrome.runtime.lastError);
        } else {
          console.log("Contato enviado com sucesso");
        }
      });
      
      // Anima√ß√£o visual
      this.style.backgroundColor = "#25D366";
      setTimeout(() => {
        this.style.backgroundColor = "rgba(37, 211, 102, 0.1)";
      }, 200);
    });
  });
  
  clickListenersAtivos = true;
}

// Fun√ß√£o para desativar modo de sele√ß√£o
function desativarModoSelecaoContatos() {
  console.log("Desativando modo de sele√ß√£o de contatos");
  
  const conversas = document.querySelectorAll('[data-testid="chat-list-item"]');
  conversas.forEach((conversa) => {
    conversa.style.cursor = "default";
    conversa.style.border = "";
    conversa.style.backgroundColor = "";
  });
  
  clickListenersAtivos = false;
}

console.log("‚úì Content Script pronto para comunica√ß√£o");
